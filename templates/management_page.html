{% extends 'base.html' %}

{% block title %}
    Home
{% endblock %}

{% block content %}
    
    {% load static %}
    {% if messages %}
        <div class="alert">
            {% for message in messages %}
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        showNotification("{{ message }}");
                    });
                </script>
            {% endfor %}
        </div>
    {% endif %}
    <div class="container-fluid">
        <div class="row management-page">
            <div class="col-2 folders-section">
                <h3>Folders</h3>
                <div class="table-container">
                    <table class="table">
                        <tbody>
                            {% if folders %}
                                {% for folder in folders %}
                                    <tr data-folder-id="{{ folder.id }}">
                                        <td><i class="fas fa-folder file-icon pe-2 ps-3"></i>{{ folder.name }}</td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <table class="table">
                    <tfoot>
                        <tr>
                            <td class="icon-bar">
                                <i class="fas fa-plus" data-bs-toggle="modal" data-bs-target="#addFolderModal"></i>
                                <i class="fas fa-minus delete-folder-btn" data-bs-toggle="modal" data-bs-target="#deleteFolderModal"></i>
                                <i class="fas fa-arrow-up move-folder-up-btn"></i>
                                <i class="fas fa-arrow-down move-folder-down-btn"></i>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="col-2 folder-details-section" style="display: none;">
                <h3 id="folderName">Folders</h3>
                <div class="table-container">
                    <table class="table" id="folderDetailsTable">
                        <tbody id="folderDetails">
                            <!-- Records will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
                <table class="table">
                    <tfoot>
                        <tr>
                            <td class="icon-bar">
                                <i class="fas fa-arrow-left back-icon" id="backIcon" style="background: #0ca80c;"></i>
                                <i class="fas fa-minus delete-record-btn" data-bs-toggle="modal" data-bs-target="#deleteRecordModal"></i>
                                <i class="fas fa-arrow-up move-record-up-btn"></i>
                                <i class="fas fa-arrow-down move-record-down-btn"></i>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Add Folder Modal -->
            <div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="addFolderModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addFolderModalLabel">Add Folder</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addFolderForm" method="post" action="{% url 'add_folder' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="folder_name" class="form-label">Folder Name</label>
                                    <input type="text" class="form-control" id="folder_name" name="folder_name" required>
                                </div>
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">Add Folder</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Folder Modal -->
            <div class="modal fade" id="deleteFolderModal" tabindex="-1" aria-labelledby="deleteFolderModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteFolderModalLabel">Delete Folder</h5>
                            <button type="button" class="btn-close" onclick="closeDeleteFolderModal()" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <p id="deleteFolderMessage"></p>
                            <form id="deleteFolderForm" method="post" action="{% url 'delete_folder' %}">
                                {% csrf_token %}
                                <input type="hidden" id="deleteFolderId" name="folder_id">
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-danger">Delete Folder</button>
                                    <button type="button" class="btn btn-secondary" onclick="closeDeleteFolderModal()">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Record Modal -->
            <div class="modal fade" id="deleteRecordModal" tabindex="-1" aria-labelledby="deleteRecordModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteRecordModalLabel">Delete Record</h5>
                            <button type="button" class="btn-close" onclick="closeDeleteRecordModal()" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <p id="deleteRecordMessage"></p>
                            <form id="deleteRecordForm" method="post" action="{% url 'delete_record' %}">
                                {% csrf_token %}
                                <input type="hidden" id="deleteRecordId" name="record_id">
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-danger">Delete Record</button>
                                    <button type="button" class="btn btn-secondary" onclick="closeDeleteRecordModal()">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="col-7 procedures-section">
                <h3>Procedures</h3>
                <div class="table-container procedures-table">
                    <!-- Add your table for procedures here -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">Select</th>
                                <th style="width: 9%;">CPT</th>
                                <th style="width: 9%;">MOD.</th>
                                <th>DESCRIPTION</th>
                                <th style="width: 9%;">RVU</th>
                                <th style="width: 18%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for procedure in procedures %}
                                <tr>
                                    <td><input type="checkbox" class="form-check-input procedure-checkbox" value="{{ procedure.id }}" data-procedure-id="{{ procedure.id }}"></td>
                                    <td>{{ procedure.cpt }}</td>
                                    <td>{{ procedure.modality }}</td>
                                    <td>{{ procedure.description }}</td>
                                    <td>{{ procedure.rvu }}</td>
                                    <td>
                                        <a href="#" class="btn btn-primary me-2 edit-procedure-btn" data-bs-toggle="modal" data-bs-target="#editProcedureModal" data-procedure-id="{{ procedure.id }}">Edit</a>
                                        <a href="#" class="btn btn-danger delete-procedure-btn" data-procedure-id="{{ procedure.id }}">Delete</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="#" class="btn btn-success add_btn" data-bs-toggle="modal" data-bs-target="#addProcedureModal">Add</a>
            </div>

            <!-- Add Procedure Modal -->
            <div class="modal fade" id="addProcedureModal" tabindex="-1" aria-labelledby="addProcedureModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h4 class="modal-title" id="addProcedureModalLabel">Add Procedure</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Add Procedure Form -->
                            <form id="addProcedureForm">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="cpt" class="form-label">CPT</label>
                                    <input type="text" class="form-control" id="cpt" name="cpt" required>
                                </div>
                                <div class="mb-3">
                                    <label for="modality" class="form-label">MOD.</label>
                                    <select class="form-select" id="modality" name="modality" required>
                                        <option value=""></option>
                                        <option value="CR">CR</option>
                                        <option value="CT">CT</option>
                                        <option value="MG">MG</option>
                                        <option value="MR">MR</option>
                                        <option value="NM">NM</option>
                                        <option value="OT">OT</option>
                                        <option value="PT">PT</option>
                                        <option value="US">US</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">DESCRIPTION</label>
                                    <textarea class="form-control" id="description" name="description" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="rvu" class="form-label">RVU</label>
                                    <input type="number" class="form-control" id="rvu" name="rvu" step="0.01" required>
                                </div>
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Procedure Modal -->
            <div class="modal fade" id="editProcedureModal" tabindex="-1" aria-labelledby="editProcedureModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h4 class="modal-title" id="editProcedureModalLabel">Edit Procedure</h4>
                            <button type="button" class="btn-close" onclick="closeEditProcedureModal()" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Edit Procedure Form -->
                            <form id="editProcedureForm">
                                {% csrf_token %}
                                <input type="hidden" id="editProcedureId" name="procedure_id">
                                <div class="mb-3">
                                    <label for="editCpt" class="form-label">CPT</label>
                                    <input type="text" class="form-control" id="editCpt" name="cpt" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editModality" class="form-label">MOD.</label>
                                    <select class="form-select" id="editModality" name="modality" required>
                                        <option value=""></option>
                                        <option value="CR">CR</option>
                                        <option value="CT">CT</option>
                                        <option value="MG">MG</option>
                                        <option value="MR">MR</option>
                                        <option value="NM">NM</option>
                                        <option value="OT">OT</option>
                                        <option value="PT">PT</option>
                                        <option value="US">US</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editDescription" class="form-label">DESCRIPTION</label>
                                    <textarea class="form-control" id="editDescription" name="description" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editRvu" class="form-label">RVU</label>
                                    <input type="number" class="form-control" id="editRvu" name="rvu" step="0.01" required>
                                </div>
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">Update</button>
                                    <button type="button" class="btn btn-secondary" onclick="closeEditProcedureModal()">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="col-2 shifts-section">
                <h3>Shifts</h3>
                <div class="table-container">
                    <table class="table">
                        <tbody>
                            {% if shifts %}
                                {% for shift in shifts %}
                                    <tr data-shift-id="{{ shift.id }}">
                                        <td class="ps-3">{{ shift.name }}</td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <table class="table">
                    <tfoot>
                        <tr>
                            <td class="icon-bar">
                                <i class="fas fa-plus" data-bs-toggle="modal" data-bs-target="#addShiftModal"></i>
                                <i class="fas fa-minus delete-shift-btn" data-bs-toggle="modal" data-bs-target="#deleteShiftModal"></i>
                                <i class="fas fa-arrow-up move-shift-up-btn"></i>
                                <i class="fas fa-arrow-down move-shift-down-btn"></i>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <!-- Add Shift Modal -->
            <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addShiftModalLabel">Add Shift</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addShiftForm" method="post" action="{% url 'add_shift' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="shift_name" class="form-label">Shift Name</label>
                                    <input type="text" class="form-control" id="shift_name" name="shift_name" required>
                                </div>
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">Add Shift</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Shift Modal -->
            <div class="modal fade" id="deleteShiftModal" tabindex="-1" aria-labelledby="deleteShiftModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteShiftModalLabel">Delete Shift</h5>
                            <button type="button" class="btn-close" onclick="closeDeleteShiftModal()" style="background-color: #3498db;"></button>
                        </div>
                        <div class="modal-body">
                            <p id="deleteShiftMessage"></p>
                            <form id="deleteShiftForm" method="post" action="{% url 'delete_shift' %}">
                                {% csrf_token %}
                                <input type="hidden" id="deleteShiftId" name="shift_id">
                                <div class="modal-footer d-flex justify-content-between">
                                    <button type="submit" class="btn btn-danger">Delete Shift</button>
                                    <button type="button" class="btn btn-secondary" onclick="closeDeleteShiftModal()">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Move Selected Modal -->
    <div class="modal fade" id="moveSelectedModal" tabindex="-1" aria-labelledby="moveSelectedModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: #2c3e50; color: #fff;">
                <div class="modal-header">
                    <h4 class="modal-title" id="moveSelectedModalLabel">Move Selected Procedures</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: #3498db;"></button>
                </div>
                <div class="modal-body">
                    <form id="moveSelectedForm" method="POST" action="{% url 'move_selected_to_folder' %}">
                        {% csrf_token %}
                        <!-- Add a hidden input to store the procedure ID -->
                        <input type="hidden" id="selectedProcedureIds" name="procedure_ids">
                        <div class="mb-3">
                            <label for="selectedFolder" class="form-label">Select Folder</label>
                            <select class="form-select" id="selectedFolder" name="folder_id" required>
                                <option value=""></option>
                                {% for folder in folders %}
                                    <option value="{{ folder.id }}">{{ folder.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="modal-footer d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">Move Selected</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this element to your HTML -->
    <div id="notification" class="notification">
        <span id="notificationMessage"></span>
        <button id="closeNotification" class="btn btn-danger">Close</button>
    </div>

    <script>
        function closeEditProcedureModal() {
            const editProcedureModal = new bootstrap.Modal(document.getElementById('editProcedureModal'));
            editProcedureModal.hide();
            location.reload();
        }
        function closeDeleteFolderModal() {
            const deleteFolderModal = new bootstrap.Modal(document.getElementById('deleteFolderModal'));
            deleteFolderModal.hide();
            location.reload();
        }
        function closeDeleteShiftModal() {
            const deleteShiftModal = new bootstrap.Modal(document.getElementById('deleteShiftModal'));
            deleteShiftModal.hide();
            location.reload();
        }
        function closeDeleteRecordModal() {
            const deleteRecordModal = new bootstrap.Modal(document.getElementById('deleteRecordModal'));
            deleteRecordModal.hide();
            location.reload();
        }

        // Function to show notification
        function showNotification(message, isError = false) {
            const notificationElement = document.getElementById("notification");
            const notificationMessageElement = document.getElementById("notificationMessage");

            // Set notification message and style
            notificationMessageElement.innerText = message;
            notificationElement.classList.toggle("error", isError);

            // Show notification
            notificationElement.style.display = "block";

            // Auto-close after 2 seconds
            setTimeout(function () {
                hideNotification();
            }, 2000);
        }

        // Function to hide notification
        function hideNotification() {
            const notificationElement = document.getElementById("notification");
            notificationElement.style.display = "none";
        }

        // Attach event listener to close button
        document.getElementById("closeNotification").addEventListener("click", function () {
            hideNotification();
        });

        document.addEventListener('DOMContentLoaded', function () {
            const addProcedureForm = document.getElementById('addProcedureForm');
            const editProcedureForm = document.getElementById('editProcedureForm');
        
            // Function to handle the submission of the add procedure form
            addProcedureForm.addEventListener('submit', function (e) {
                e.preventDefault();

                fetch('/add_procedure/', {
                    method: 'POST',
                    body: new FormData(addProcedureForm),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page or update the table with the new data
                        location.reload();
                    } else {
                        console.log('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.log('Error:', error);
                });
            });
        
            // Function to handle the click of the edit button
            const editButtons = document.querySelectorAll('.edit-procedure-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const procedureId = button.getAttribute('data-procedure-id');
        
                    // Fetch the procedure data to pre-fill the edit form
                    fetch(`/get_procedure/${procedureId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const procedure = data.procedure;
        
                            // Pre-fill the edit form with existing procedure data
                            editProcedureForm.querySelector('#editProcedureId').value = procedure.id;
                            editProcedureForm.querySelector('#editCpt').value = procedure.cpt;
                            editProcedureForm.querySelector('#editModality').value = procedure.modality;
                            editProcedureForm.querySelector('#editDescription').value = procedure.description;
                            editProcedureForm.querySelector('#editRvu').value = procedure.rvu;
        
                            // Open the edit procedure modal
                            const editProcedureModal = new bootstrap.Modal(document.getElementById('editProcedureModal'));
                            editProcedureModal.show();
                        } else {
                            alert('Error: Unable to fetch procedure data for editing.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });
        
            // Function to handle the submission of the edit procedure form
            editProcedureForm.addEventListener('submit', function (e) {
                e.preventDefault();
        
                fetch('/edit_procedure/', {
                    method: 'POST',
                    body: new FormData(editProcedureForm),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page or update the table with the new data
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        
            // Function to handle the click of the delete button
            const deleteButtons = document.querySelectorAll('.delete-procedure-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const procedureId = button.getAttribute('data-procedure-id');
        
                    // Confirm before proceeding with the delete operation
                    const isConfirmed = confirm('Are you sure you want to delete this procedure?');
                    if (isConfirmed) {
                        // Send a request to delete the procedure
                        fetch(`/delete_procedure/${procedureId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload the page without adding to the browser's history
                                history.replaceState(null, '', window.location.pathname);
                                // Refresh the page or update the table after deletion
                                location.reload();
                            } else {
                                alert('Error: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    }
                });
            });

            // Function to get the CSRF token from the cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Function to handle the click of the move folder up button
            const moveFolderUpBtn = document.querySelector('.move-folder-up-btn');
            moveFolderUpBtn.addEventListener('click', function () {
                moveFolder('up');
            });

            // Function to handle the click of the move folder down button
            const moveFolderDownBtn = document.querySelector('.move-folder-down-btn');
            moveFolderDownBtn.addEventListener('click', function () {
                moveFolder('down');
            });

            // Keep track of the currently selected folder ID
            let selectedFolderId = null;

            // Event listener for click on a folder
            const foldersTable = document.querySelector('.folders-section .table');
            foldersTable.addEventListener('click', function (event) {
                const targetFolder = event.target.closest('tr[data-folder-id]');
                if (targetFolder) {
                    const folderId = targetFolder.getAttribute('data-folder-id');

                    // If the clicked folder is already selected, deselect it
                    if (selectedFolderId === folderId) {
                        targetFolder.classList.remove('selected-folder');
                        selectedFolderId = null;
                    } else {
                        // Deselect the previously selected folder
                        const previousSelectedFolder = foldersTable.querySelector(`tr[data-folder-id="${selectedFolderId}"]`);
                        if (previousSelectedFolder) {
                            previousSelectedFolder.classList.remove('selected-folder');
                        }

                        // Select the clicked folder
                        targetFolder.classList.add('selected-folder');
                        selectedFolderId = folderId;
                    }
                }
            });

            // Function to handle the click of the delete folder button
            const deleteFolderBtn = document.querySelector('.delete-folder-btn');
            deleteFolderBtn.addEventListener('click', function () {
                const activeFolder = document.querySelector('.folders-section .table tbody tr.selected-folder');
                if (activeFolder) {
                    const folderName = activeFolder.querySelector('td').innerText;
                    document.getElementById('deleteFolderMessage').innerText = `Do you want to delete "${folderName}"?`;
                    document.getElementById('deleteFolderId').value = activeFolder.getAttribute('data-folder-id');
                    const deleteFolderModal = new bootstrap.Modal(document.getElementById('deleteFolderModal'));
                    deleteFolderModal.show();
                }
            });

            function moveFolder(direction) {
                const activeFolder = document.querySelector('.folders-section .table tbody tr.selected-folder');
                if (activeFolder) {
                    const targetFolder = direction === 'up' ? activeFolder.previousElementSibling : activeFolder.nextElementSibling;
                    if (targetFolder) {
                        // Rearrange the folder list in the DOM
                        activeFolder.parentNode.insertBefore(activeFolder, direction === 'up' ? targetFolder : targetFolder.nextElementSibling);
            
                        // Update the order locally
                        updateOrderForFolder();
            
                        // Send reordered data to the server
                        sendOrderToServerForFolder();
                    }
                }
            }
            
            function updateOrderForFolder() {
                const folders = document.querySelectorAll('.folders-section .table tbody tr');
                folders.forEach((folder, index) => {
                    folder.dataset.order = index + 1;
                });
            }
            
            function sendOrderToServerForFolder() {
                const folderOrder = [];
                const folders = document.querySelectorAll('.folders-section .table tbody tr');
                folders.forEach(folder => {
                    const folderId = folder.dataset.folderId;
                    const folderOrderValue = folder.dataset.order;
                    folderOrder.push({ id: folderId, order: folderOrderValue });
                });
            
                // Get the CSRF token from the cookie
                const csrftoken = getCookie('csrftoken');

                // Send AJAX request to update the server-side order
                $.ajax({
                    url: '/update_folder_order/',
                    type: 'POST',
                    data: { folder_order: JSON.stringify(folderOrder) },
                    headers: { 'X-CSRFToken': csrftoken },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Order updated successfully');
                    },
                    error: function (error) {
                        console.error('Error updating order:', error);
                    }
                });
            }

            // Function to handle the click of the move shift up button
            const moveShiftUpBtn = document.querySelector('.move-shift-up-btn');
            moveShiftUpBtn.addEventListener('click', function () {
                moveShift('up');
            });

            // Function to handle the click of the move shift down button
            const moveShiftDownBtn = document.querySelector('.move-shift-down-btn');
            moveShiftDownBtn.addEventListener('click', function () {
                moveShift('down');
            });

            // Keep track of the currently selected shift ID
            let selectedShiftId = null;

            // Event listener for click on a shift
            const shiftsTable = document.querySelector('.shifts-section .table');
            shiftsTable.addEventListener('click', function (event) {
                const targetShift = event.target.closest('tr[data-shift-id]');
                if (targetShift) {
                    const shiftId = targetShift.getAttribute('data-shift-id');

                    // If the clicked shift is already selected, deselect it
                    if (selectedShiftId === shiftId) {
                        targetShift.classList.remove('selected-shift');
                        selectedShiftId = null;
                    } else {
                        // Deselect the previously selected shift
                        const previousSelectedShift = shiftsTable.querySelector(`tr[data-shift-id="${selectedShiftId}"]`);
                        if (previousSelectedShift) {
                            previousSelectedShift.classList.remove('selected-shift');
                        }

                        // Select the clicked shift
                        targetShift.classList.add('selected-shift');
                        selectedShiftId = shiftId;
                    }
                }
            });

            // Function to handle the click of the delete shift button
            const deleteShiftBtn = document.querySelector('.delete-shift-btn');
            deleteShiftBtn.addEventListener('click', function () {
                const activeShift = document.querySelector('.shifts-section .table tbody tr.selected-shift');
                if (activeShift) {
                    const shiftName = activeShift.querySelector('td').innerText;
                    document.getElementById('deleteShiftMessage').innerText = `Do you want to delete "${shiftName}"?`;
                    document.getElementById('deleteShiftId').value = activeShift.getAttribute('data-shift-id');
                    const deleteShiftModal = new bootstrap.Modal(document.getElementById('deleteShiftModal'));
                    deleteShiftModal.show();
                }
            });

            function moveShift(direction) {
                const activeShift = document.querySelector('.shifts-section .table tbody tr.selected-shift');
                if (activeShift) {
                    const targetShift = direction === 'up' ? activeShift.previousElementSibling : activeShift.nextElementSibling;
                    if (targetShift) {
                        // Rearrange the shift list in the DOM
                        activeShift.parentNode.insertBefore(activeShift, direction === 'up' ? targetShift : targetShift.nextElementSibling);
            
                        // Update the order locally
                        updateOrderForShift();
            
                        // Send reordered data to the server
                        sendOrderToServerForShift();
                    }
                }
            }
            
            function updateOrderForShift() {
                const shifts = document.querySelectorAll('.shifts-section .table tbody tr');
                shifts.forEach((shift, index) => {
                    shift.dataset.order = index + 1;
                });
            }
            
            function sendOrderToServerForShift() {
                const shiftOrder = [];
                const shifts = document.querySelectorAll('.shifts-section .table tbody tr');
                shifts.forEach(shift => {
                    const shiftId = shift.dataset.shiftId;
                    const shiftOrderValue = shift.dataset.order;
                    shiftOrder.push({ id: shiftId, order: shiftOrderValue });
                });
            
                // Get the CSRF token from the cookie
                const csrftoken = getCookie('csrftoken');

                // Send AJAX request to update the server-side order
                $.ajax({
                    url: '/update_shift_order/',
                    type: 'POST',
                    data: { shift_order: JSON.stringify(shiftOrder) },
                    headers: { 'X-CSRFToken': csrftoken },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Order updated successfully');
                    },
                    error: function (error) {
                        console.error('Error updating order:', error);
                    }
                });
            }

            const proceduresTable = document.querySelector('.procedures-section');
            proceduresTable.addEventListener('contextmenu', function (event) {
                event.preventDefault();

                // Check if the right-click was on a checkbox
                const selectedProcedureIds = Array.from(document.querySelectorAll('.procedure-checkbox:checked'))
                        .map(checkbox => checkbox.getAttribute('data-procedure-id'));

                    // Display a modal with the selected procedure ids
                    if (selectedProcedureIds.length > 0) {
                        // Customize this part to show the modal or perform any other action
                        document.getElementById('selectedProcedureIds').value = selectedProcedureIds.join(',');
                        const moveSelectedModal = new bootstrap.Modal(document.getElementById('moveSelectedModal'));
                        moveSelectedModal.show();
                        //alert('Selected Procedure IDs: ' + selectedProcedureIds.join(', '));
                    }
            });

            const foldersSection = document.querySelector('.folders-section');
            const folderDetailsSection = document.querySelector('.folder-details-section');

            // Check if there is a selected folder ID in local storage
            const storedFolderId = localStorage.getItem('selectedFolderId');
            if (storedFolderId) {
                // Load folder details if there is a stored folder ID
                loadFolderDetails(storedFolderId);
            }

            // Add event listener for double-click on a folder name
            foldersSection.addEventListener('dblclick', function (event) {
                const targetFolder = event.target.closest('tr[data-folder-id]');
                if (targetFolder) {
                    const folderId = targetFolder.getAttribute('data-folder-id');
                    loadFolderDetails(folderId);
                }
            });

            // Function to load folder details
            function loadFolderDetails(folderId) {
                // Save the selected folder ID to local storage
                localStorage.setItem('selectedFolderId', folderId);

                // You can make an AJAX request to your Django view to get folder details
                // Update the URL according to your Django view
                const url = `/get_folder_details/${folderId}/`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Update the folder name in the top section
                        const folderName = document.getElementById('folderName');
                        folderName.innerText = data.folderName;

                        // Update the folder details table
                        const folderDetails = document.getElementById('folderDetails');
                        folderDetails.innerHTML = '';

                        if (data.records.length > 0) {
                            data.records.forEach((record, index) => {
                                const row = document.createElement('tr');
                                row.setAttribute('data-record-id', record.id);
                                row.innerHTML = `<td>${record.procedure__description}</td>`;
                                folderDetails.appendChild(row);
                            });
                        } else {
                            folderDetails.innerHTML = '<tr><td>No records in this folder</td></tr>';
                        }

                        // Show the folder details section and hide the folders section
                        foldersSection.style.display = 'none';
                        folderDetailsSection.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading folder details:', error);
                    });
            }

            // Add event listener for the back icon to return to the folders view
            const backIcon = document.getElementById('backIcon');
            backIcon.addEventListener('click', function () {
                localStorage.removeItem('selectedFolderId');

                // Show the folders section and hide the folder details section
                folderDetailsSection.style.display = 'none';
                foldersSection.style.display = 'block';

            });

            // Function to handle the click of the move record up button
            const moveRecordUpBtn = document.querySelector('.move-record-up-btn');
            moveRecordUpBtn.addEventListener('click', function () {
                moveRecord('up');
            });

            // Function to handle the click of the move record down button
            const moveRecordDownBtn = document.querySelector('.move-record-down-btn');
            moveRecordDownBtn.addEventListener('click', function () {
                moveRecord('down');
            });

            // Keep track of the currently selected record ID
            let selectedRecordId = null;

            // Event listener for click on a record
            const recordsTable = document.querySelector('.folder-details-section .table');
            recordsTable.addEventListener('click', function (event) {
                const targetRecord = event.target.closest('tr[data-record-id]');
                if (targetRecord) {
                    const recordId = targetRecord.getAttribute('data-record-id');

                    // If the clicked record is already selected, deselect it
                    if (selectedRecordId === recordId) {
                        targetRecord.classList.remove('selected-record');
                        selectedRecordId = null;
                    } else {
                        // Deselect the previously selected record
                        const previousSelectedRecord = recordsTable.querySelector(`tr[data-record-id="${selectedRecordId}"]`);
                        if (previousSelectedRecord) {
                            previousSelectedRecord.classList.remove('selected-record');
                        }

                        // Select the clicked record
                        targetRecord.classList.add('selected-record');
                        selectedRecordId = recordId;
                    }
                }
            });

            // Function to handle the click of the delete record button
            const deleteRecordBtn = document.querySelector('.delete-record-btn');
            deleteRecordBtn.addEventListener('click', function () {
                const activeRecord = document.querySelector('.folder-details-section .table tbody tr.selected-record');
                if (activeRecord) {
                    const recordName = activeRecord.querySelector('td').innerText;
                    const folderName = folderDetailsSection.querySelector('h3').innerText;
                    document.getElementById('deleteRecordMessage').innerText = `Do you want to delete "${recordName}" from "${folderName}" folder?`;
                    document.getElementById('deleteRecordId').value = activeRecord.getAttribute('data-record-id');
                    const deleteRecordModal = new bootstrap.Modal(document.getElementById('deleteRecordModal'));
                    deleteRecordModal.show();
                }
            });

            function moveRecord(direction) {
                const activeRecord = document.querySelector('.folder-details-section .table tbody tr.selected-record');
                if (activeRecord) {
                    const targetRecord = direction === 'up' ? activeRecord.previousElementSibling : activeRecord.nextElementSibling;
                    if (targetRecord) {
                        // Rearrange the record list in the DOM
                        activeRecord.parentNode.insertBefore(activeRecord, direction === 'up' ? targetRecord : targetRecord.nextElementSibling);
            
                        // Update the order locally
                        updateOrder();
            
                        // Send reordered data to the server
                        sendOrderToServer();
                    }
                }
            }
            
            function updateOrder() {
                const records = document.querySelectorAll('.folder-details-section .table tbody tr');
                records.forEach((record, index) => {
                    record.dataset.order = index + 1;
                });
            }
            
            function sendOrderToServer() {
                const folderProcedureOrder = [];
                const records = document.querySelectorAll('.folder-details-section .table tbody tr');
                records.forEach(record => {
                    const folderProcedureId = record.dataset.recordId;
                    const folderProcedureOrderValue = record.dataset.order;
                    folderProcedureOrder.push({ id: folderProcedureId, order: folderProcedureOrderValue });
                });
            
                // Get the CSRF token from the cookie
                const csrftoken = getCookie('csrftoken');
            
                // Send AJAX request to update the server-side order
                $.ajax({
                    url: '/update_folder_procedure_order/',
                    type: 'POST',
                    data: { folder_procedure_order: JSON.stringify(folderProcedureOrder) },
                    headers: { 'X-CSRFToken': csrftoken },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Order updated successfully');
                    },
                    error: function (error) {
                        console.error('Error updating order:', error);
                    }
                });
            }

            // Add event listener for when a link is clicked
            document.addEventListener('click', function (event) {
                const isNavLink = event.target.closest('a.nav-link');
                const isNavbarBrand = event.target.closest('a.navbar-brand');
                if (isNavLink || isNavbarBrand) {
                    // Clear the selected folder ID from local storage when navigating to another page
                    localStorage.removeItem('selectedFolderId');
                }
            });
            
        });
    </script>
{% endblock content %}

